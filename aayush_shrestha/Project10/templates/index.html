<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turing Machine Simulator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ Turing Machine Simulator</h1>
            <p>A visual simulator for deterministic Turing Machines</p>
        </header>

        <div class="machine-selector">
            <h2>Select Machine</h2>
            <select id="machineSelect">
                {% for key, machine in machines.items() %}
                <option value="{{ key }}">{{ machine.name }}</option>
                {% endfor %}
            </select>
            <div id="machineDescription" class="description"></div>
        </div>

        <div class="input-section">
            <h2>Input String</h2>
            <input type="text" id="inputString" placeholder="Enter input (e.g., 101)">
            <button onclick="runMachine()" class="btn-primary">Run Machine</button>
            <div class="examples" id="examples"></div>
        </div>

        <div class="results" id="results" style="display:none;">
            <h2>Execution Results</h2>
            <div class="result-status" id="resultStatus"></div>
            <div class="result-info">
                <span>Total Steps: <strong id="stepCount">0</strong></span>
            </div>
            
            <h3>State Trace</h3>
            <div class="trace-container" id="traceContainer"></div>
        </div>

        <footer>
            <p>Created for COSC352 Project 10 | Aayush Shrestha | Morgan State University</p>
        </footer>
    </div>

    <script>
        const machines = {{ machines | tojson }};
        
        // Update machine description on selection
        document.getElementById('machineSelect').addEventListener('change', updateMachineInfo);
        
        function updateMachineInfo() {
            const selected = document.getElementById('machineSelect').value;
            const machine = machines[selected];
            
            document.getElementById('machineDescription').innerHTML = 
                `<p>${machine.description}</p>`;
            
            let examplesHtml = '<div class="example-buttons">';
            examplesHtml += '<strong>Try examples:</strong> ';
            machine.example_accept.forEach(ex => {
                examplesHtml += `<button class="btn-example" onclick="setInput('${ex}')">${ex || '(empty)'}</button> `;
            });
            if (machine.example_reject.length > 0) {
                examplesHtml += '<br><strong>Should reject:</strong> ';
                machine.example_reject.forEach(ex => {
                    examplesHtml += `<button class="btn-example reject" onclick="setInput('${ex}')">${ex}</button> `;
                });
            }
            examplesHtml += '</div>';
            document.getElementById('examples').innerHTML = examplesHtml;
        }
        
        function setInput(value) {
            document.getElementById('inputString').value = value;
        }
        
        async function runMachine() {
            const machine = document.getElementById('machineSelect').value;
            const input = document.getElementById('inputString').value;
            
            // Clear previous results
            document.getElementById('results').style.display = 'none';
            document.getElementById('traceContainer').innerHTML = '<p>Running...</p>';
            
            try {
                const response = await fetch('/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ machine, input })
                });
                
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                alert('Error running machine: ' + error.message);
            }
        }
        
        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            
            // Status
            const statusDiv = document.getElementById('resultStatus');
            if (data.passed) {
                statusDiv.className = 'result-status accept';
                statusDiv.innerHTML = '‚úÖ ACCEPTED';
            } else if (data.result === 'REJECT') {
                statusDiv.className = 'result-status reject';
                statusDiv.innerHTML = '‚ùå REJECTED';
            } else {
                statusDiv.className = 'result-status error';
                statusDiv.innerHTML = '‚ö†Ô∏è ' + data.result;
            }
            
            // Step count
            document.getElementById('stepCount').textContent = data.steps;
            
            // Trace
            let traceHtml = '<div class="trace-list">';
            data.trace.forEach((entry, idx) => {
                traceHtml += `
                    <div class="trace-entry">
                        <div class="trace-step">Step ${entry.step}</div>
                        <div class="trace-state">State: <code>${entry.state}</code></div>
                        <div class="trace-tape">
                            <div class="tape-content"><code>${entry.tape}</code></div>
                            <div class="tape-head"><code>${entry.head_indicator}</code></div>
                        </div>
                        <div class="trace-action">${entry.action}</div>
                    </div>
                `;
            });
            traceHtml += '</div>';
            document.getElementById('traceContainer').innerHTML = traceHtml;
        }
        
        // Initialize
        updateMachineInfo();
    </script>
</body>
</html>
